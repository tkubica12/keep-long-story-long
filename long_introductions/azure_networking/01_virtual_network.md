# Virtual network
In this lab we will create virtual network with subnets, deploy virtual machines and test connectivity.

First we will create resource group, virtual network with three subnets.

```bash
# Configure prefix
export prefix=klsl

# Create resource group
az group create -n $prefix-project1 -l northeurope

# Create VNET
az network vnet create -n $prefix-project1 -g $prefix-project1 --address-prefix 10.1.0.0/16

# Create three subnets
az network vnet subnet create -n jump     -g $prefix-project1 --vnet-name $prefix-project1 --address-prefixes 10.1.0.0/24
az network vnet subnet create -n frontend -g $prefix-project1 --vnet-name $prefix-project1 --address-prefixes 10.1.1.0/24
az network vnet subnet create -n backend  -g $prefix-project1 --vnet-name $prefix-project1 --address-prefixes 10.1.2.0/24
```

We will now deploy few servers with serial access enabled to test things out. We will have one jump server, two frontend server (each in separate availability zone - different physical datacenters) and one backend.

```bash
az vm create -n $prefix-jump \
    -g $prefix-project1 \
    --image Ubuntu2204 \
    --vnet-name $prefix-project1 \
    --subnet jump \
    --size Standard_D2a_v4 \
    --admin-username labuser \
    --admin-password Azure12345678 \
    --authentication-type password \
    --zone 1 \
    --private-ip-address 10.1.0.10 \
    --public-ip-address "" \
    --nsg "" \
    --no-wait
az vm create -n $prefix-front1 \
    -g $prefix-project1 \
    --image Ubuntu2204 \
    --vnet-name $prefix-project1 \
    --subnet frontend \
    --size Standard_D2a_v4 \
    --admin-username labuser \
    --admin-password Azure12345678 \
    --authentication-type password \
    --zone 1 \
    --private-ip-address 10.1.1.11 \
    --public-ip-address "" \
    --nsg "" \
    --no-wait
az vm create -n $prefix-front2 \
    -g $prefix-project1 \
    --image Ubuntu2204 \
    --vnet-name $prefix-project1 \
    --subnet frontend \
    --size Standard_D2a_v4 \
    --admin-username labuser \
    --admin-password Azure12345678 \
    --authentication-type password \
    --zone 2 \
    --private-ip-address 10.1.1.12 \
    --public-ip-address "" \
    --nsg "" \
    --no-wait
az vm create -n $prefix-back \
    -g $prefix-project1 \
    --image Ubuntu2204 \
    --vnet-name $prefix-project1 \
    --subnet backend \
    --size Standard_D2a_v4 \
    --admin-username labuser \
    --admin-password Azure12345678 \
    --authentication-type password \
    --zone 1 \
    --private-ip-address 10.1.2.10 \
    --public-ip-address "" \
    --nsg "" \
    --no-wait
```

There are no restrictions currently in our setup, every VM can reach every other. Also there is implicit SNAT to Internet. To exit serial console you type CTRL+] and press q.

```bash
# Enable serial access to all our VMs
az vm boot-diagnostics enable --ids $(az vm list -g $prefix-project1 --query "[].id" -o tsv)

# Connect to VMs
export prefix=klsl
az serial-console connect -n $prefix-jump -g $prefix-project1   
az serial-console connect -n $prefix-front1 -g $prefix-project1
az serial-console connect -n $prefix-front2 -g $prefix-project1 

# Test connectivity
export prefix=klsl
ping -c 2 $prefix-front1
ping -c 2 $prefix-front2
ping -c 2 $prefix-back

# No broadcast, ARP manupulation etc. - cloud is pure L3 (ARP response generated by hypervisor host router of your VNET)
# Do this on front1
export prefix=klsl
ping -c 2 $prefix-front2    # OK

# Do this on front2
sudo ip a change 10.1.1.123/24 dev eth0
sudo ip a del 10.1.1.12/24 dev eth0

# Do this on front1
ping -c 2 $prefix-front2    # FAILS! No broadcast, gARP etc.
sudo apt install net-tools
arp -a

# Do this on front2
sudo ip a del 10.1.1.123/24 dev eth0
sudo dhclient

# Do this on front1
ping -c 2 $prefix-front2    # OK
```